<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Efficiency Exchange</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #fff; font-family: Arial, sans-serif; margin: 0; }
        .hidden { display: none !important; }
        .container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: #fff; }
        .center { text-align: center; }
        .input { width: 100%; padding: 14px; font-size: 1.1rem; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; font-size: 1.1rem; border-radius: 8px; border: none; background: #111; color: #fff; font-weight: bold; margin-bottom: 16px; cursor: pointer; }
        .btn-google, .btn-apple { width: 100%; padding: 14px; font-size: 1.1rem; border-radius: 8px; border: 1px solid #ddd; background: #fff; color: #111; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; cursor: pointer; }
        .btn-google img, .btn-apple img { width: 22px; margin-right: 10px; }
        .or { text-align: center; color: #aaa; margin: 18px 0 12px 0; position: relative; }
        .or:before, .or:after { content: ""; display: inline-block; width: 40%; height: 1px; background: #eee; vertical-align: middle; margin: 0 8px; }
        .nav-bar { position: fixed; left: 0; right: 0; bottom: 0; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; height: 60px; z-index: 10; }
        .nav-bar .nav-btn { flex: 1; text-align: center; color: #aaa; font-size: 1.7rem; padding: 8px 0; cursor: pointer; }
        .nav-bar .active { color: #111; }
        .main-title { font-size: 2rem; font-weight: bold; margin: 32px 0 18px 0; text-align: center; }
        .rate-card { background: #111; color: #fff; border-radius: 16px; padding: 20px; margin-bottom: 24px; display: flex; flex-direction: column; align-items: flex-start; }
        .rate-label { font-size: 1.1rem; font-weight: 600; }
        .rate-value { font-size: 2.2rem; font-weight: bold; margin: 8px 0; }
        .rate-change { font-size: 1rem; opacity: 0.7; }
        .chart-block { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 24px; }
        .chart-label { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
        .country-select { width: 100%; font-size: 1.1rem; padding: 8px 16px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 18px; }
        .country-list { margin: 0 0 24px 0; }
        .country-item { display: flex; align-items: center; margin-bottom: 12px; }
        .country-flag { width: 36px; height: 36px; border-radius: 50%; margin-right: 12px; }
        .country-info { line-height: 1.2; }
        .country-name { font-weight: bold; }
        .country-local { color: #888; font-size: 0.95em; }
        .chat-area { background: #f8f8f8; border-radius: 12px; padding: 16px; height: 340px; overflow-y: auto; margin-bottom: 12px; }
        .msg { margin-bottom: 14px; display: flex; }
        .msg.user { justify-content: flex-end; }
        .msg .bubble { max-width: 70%; padding: 12px 16px; border-radius: 16px; font-size: 1.08rem; }
        .msg.user .bubble { background: #111; color: #fff; border-bottom-right-radius: 4px; }
        .msg.bot .bubble { background: #eee; color: #111; border-bottom-left-radius: 4px; }
        .chat-input-row { display: flex; }
        .chat-input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1.1rem; }
        .chat-send { background: #1976d2; color: #fff; border: none; border-radius: 8px; padding: 0 18px; margin-left: 8px; font-size: 1.2rem; cursor: pointer; }
        .confirm-block { background: #fff; border-radius: 16px; padding: 20px; margin: 24px 0; }
        .confirm-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .confirm-row:last-child { border-bottom: none; }
        .confirm-label { color: #888; }
        .confirm-value { font-weight: bold; }
        .confirm-btn { width: 100%; padding: 16px; font-size: 1.1rem; border-radius: 8px; border: none; background: #111; color: #fff; font-weight: bold; margin-top: 24px; cursor: pointer; }
        .option-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
        .option-btn { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px 16px; text-align: left; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .option-btn:hover { background: #f0f0f0; border-color: #ccc; }
        .profile-section { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 24px; }
        .profile-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        .profile-info { flex: 1; }
        .profile-name { font-size: 1.4rem; font-weight: bold; margin-bottom: 4px; }
        .profile-email { color: #666; }
        .profile-menu { list-style: none; padding: 0; margin: 0; }
        .profile-menu-item { padding: 16px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .profile-menu-item:last-child { border-bottom: none; }
        .profile-menu-item .icon { font-size: 1.2rem; color: #666; }
        .profile-menu-item .text { font-size: 1.1rem; }
        .profile-menu-item .arrow { color: #ccc; }
        .language-modal { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 999; align-items: center; justify-content: center; }
        .language-content { background: #fff; padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; }
        .language-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 16px; text-align: center; }
        .language-list { list-style: none; padding: 0; margin: 0; }
        .language-item { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .language-item:last-child { border-bottom: none; }
        .language-item:hover { background: #f8f8f8; }
        .language-item.active { background: #f0f0f0; }
        .language-flag { width: 24px; height: 24px; border-radius: 50%; }
        .language-name { flex: 1; }
        .language-check { color: #1976d2; font-weight: bold; }
        @media (max-width: 600px) {
            .container { max-width: 100vw; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å…¥é  -->
        <div id="loginPage">
            <div style="height: 60px;"></div>
            <div class="main-title">Efficiency<br>exchange</div>
            <div class="center" style="margin-bottom: 24px; font-size:1.15rem; font-weight:600;">Sign in to your account</div>
            <input id="loginEmail" class="input" type="email" placeholder="email@domain.com" autocomplete="username">
            <input id="loginPwd" class="input" type="password" placeholder="Password" autocomplete="current-password">
            <button class="btn" onclick="login()">Sign In</button>
            <button class="btn" style="background:#1976d2;" onclick="showPage('registerPage')">Register</button>
            <button class="btn" style="background:#888;" onclick="showPage('forgotPage')">Forgot Password</button>
            <div class="or">or</div>
            <button class="btn-google"><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg">Continue with Google</button>
            <button class="btn-apple"><img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg">Continue with Apple</button>
            <div style="color:#888; font-size:0.98em; text-align:center; margin-top:18px;">By clicking continue, you agree to our <a href="#" style="color:#1976d2;">Terms of Service</a> and <a href="#" style="color:#1976d2;">Privacy Policy</a></div>
        </div>

        <!-- è¨»å†Šé  -->
        <div id="registerPage" class="hidden">
            <div style="height: 60px;"></div>
            <div class="main-title">Register</div>
            <input id="regEmail" class="input" type="email" placeholder="email@domain.com">
            <input id="regPwd" class="input" type="password" placeholder="Password">
            <input id="regPwd2" class="input" type="password" placeholder="Confirm Password">
            <button class="btn" onclick="register()">Register</button>
            <button class="btn" style="background:#888;" onclick="showPage('loginPage')">Back to Login</button>
        </div>

        <!-- å¿˜è¨˜å¯†ç¢¼é  -->
        <div id="forgotPage" class="hidden">
            <div style="height: 60px;"></div>
            <div class="main-title">Forgot Password</div>
            <input id="forgotEmail" class="input" type="email" placeholder="email@domain.com">
            <input id="forgotPwd" class="input" type="password" placeholder="New Password">
            <input id="forgotPwd2" class="input" type="password" placeholder="Confirm New Password">
            <button class="btn" onclick="resetPassword()">Reset Password</button>
            <button class="btn" style="background:#888;" onclick="showPage('loginPage')">Back to Login</button>
        </div>

        <!-- ä¿®æ”¹å¯†ç¢¼é ï¼ˆç™»å…¥å¾Œï¼‰ -->
        <div id="changePwdPage" class="hidden">
            <div style="height: 60px;"></div>
            <div class="main-title">Change Password</div>
            <input id="oldPwd" class="input" type="password" placeholder="Old Password">
            <input id="newPwd" class="input" type="password" placeholder="New Password">
            <input id="newPwd2" class="input" type="password" placeholder="Confirm New Password">
            <button class="btn" onclick="changePassword()">Change Password</button>
            <button class="btn" style="background:#888;" onclick="showPage('mainPage')">Back</button>
        </div>

        <!-- ä¸»é  -->
        <div id="mainPage" class="hidden">
            <div style="height: 24px;"></div>
            <div class="main-title">Efficiency</div>
            <select id="countrySelect" class="country-select">
                <option value="THB">Thailand</option>
                <option value="VND">Vietnam</option>
                <option value="PHP">Philippines</option>
                <option value="IDR">Indonesia</option>
            </select>
            <div id="rate-card" class="rate-card">
                <div id="pair-label" class="rate-label">TWD/THB</div>
                <div id="rate-value" class="rate-value">1.0342</div>
                <div id="change-value" class="rate-change">0.00% day over day</div>
            </div>
            <div class="chart-block">
                <div id="chart-label" class="chart-label">TWD/THB</div>
                <canvas id="chart-currency" height="120"></canvas>
            </div>
            <div class="country-list">
                <div class="country-item" onclick="goExchange('THB')" style="cursor:pointer;"><img class="country-flag" src="https://flagcdn.com/th.svg"><div class="country-info"><div class="country-name">Thailand</div><div class="country-local">à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢</div></div></div>
                <div class="country-item" onclick="goExchange('VND')" style="cursor:pointer;"><img class="country-flag" src="https://flagcdn.com/vn.svg"><div class="country-info"><div class="country-name">Vietnam</div><div class="country-local">Viá»‡t Nam</div></div></div>
                <div class="country-item" onclick="goExchange('PHP')" style="cursor:pointer;"><img class="country-flag" src="https://flagcdn.com/ph.svg"><div class="country-info"><div class="country-name">Philippines</div><div class="country-local">Pilipinas</div></div></div>
                <div class="country-item" onclick="goExchange('IDR')" style="cursor:pointer;"><img class="country-flag" src="https://flagcdn.com/id.svg"><div class="country-info"><div class="country-name">Indonesia</div><div class="country-local">Indonesia</div></div></div>
            </div>
            <div style="height: 70px;"></div>
        </div>

        <!-- æ™ºèƒ½å®¢æœé  -->
        <div id="chatPage" class="hidden">
            <div style="height: 24px;"></div>
            <div class="main-title" style="font-size:1.5rem; display:flex; align-items:center; gap:8px; justify-content:space-between;">
                <span style="display:flex;align-items:center;gap:8px;"><span style="font-size:2rem;">ğŸ¤–</span>Efficiency</span>
                <a href="tel:0928315710" style="text-decoration:none;"><img src="https://cdn-icons-png.flaticon.com/512/724/724664.png" alt="phone" style="width:32px;height:32px;vertical-align:middle;"></a>
            </div>
            <div class="chat-area" id="chatArea"></div>
            <div class="chat-input-row">
                <input id="chatInput" class="chat-input" type="text" placeholder="Message..." onkeydown="if(event.key==='Enter'){sendMsg();}">
                <button class="chat-send" onclick="sendMsg()">â¤</button>
            </div>
            <div style="height: 70px;"></div>
        </div>

        <!-- æ›åŒ¯é  -->
        <div id="exchangePage" class="hidden">
            <div style="height: 24px;"></div>
            <div class="main-title">Confirm</div>
            <div class="confirm-block">
                <div class="confirm-row"><span class="confirm-label">COUNTRY</span>
                    <select id="ex-country" class="input" style="width:140px;display:inline-block;margin:0;">
                        <option value="THB">Thailand</option>
                        <option value="VND">Vietnam</option>
                        <option value="PHP">Philippines</option>
                        <option value="IDR">Indonesia</option>
                    </select>
                </div>
                <div class="confirm-row"><span class="confirm-label">AMOUNT TWD</span><input id="ex-twd" class="input" type="number" min="1" value="3000" style="width:120px;display:inline-block;margin:0;"/></div>
                <div class="confirm-row"><span class="confirm-label">EXCHANGE RATE</span><span class="confirm-value" id="ex-rate">1.0342</span></div>
                <div class="confirm-row"><span class="confirm-label">PAYMENT</span>
                    <select id="ex-pay" class="input" style="width:140px;display:inline-block;margin:0;">
                        <option value="Family Mart">Family Mart</option>
                        <option value="7-11">7-11</option>
                        <option value="Hi-Life">Hi-Life</option>
                        <option value="OK Mart">OK Mart</option>
                    </select>
                </div>
                <div class="confirm-row"><span class="confirm-label">PROMOS</span><input id="ex-promo" class="input" type="text" placeholder="Apply promo code" style="width:140px;display:inline-block;margin:0;"/></div>
                <div style="margin-top:18px; text-align:right; color:#111; font-size:1.1rem;">Amount <span id="ex-currency">THB</span> <span id="ex-thb" style="font-weight:bold;">à¸¿ 3102.6</span></div>
                <button class="confirm-btn" onclick="confirmExchange()">Confirm</button>
            </div>
            <div style="height: 70px;"></div>
        </div>

        <!-- å°è¦½åˆ— -->
        <div class="nav-bar" id="navBar" style="display:none;">
            <div class="nav-btn active" id="navHome" onclick="showPage('mainPage')">ğŸ </div>
            <div class="nav-btn" id="navBot" onclick="showPage('chatPage')">ğŸ¤–</div>
            <div class="nav-btn" id="navExchange" onclick="showPage('exchangePage')">ğŸ”„</div>
            <div class="nav-btn" id="navProfile" onclick="showPage('profilePage')">ğŸ‘¤</div>
        </div>

        <!-- Profile é é¢ -->
        <div id="profilePage" class="hidden">
            <div style="height: 24px;"></div>
            <div class="main-title">Profile</div>
            <div class="profile-section">
                <div class="profile-header">
                    <div class="profile-avatar">ğŸ‘¤</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">User</div>
                        <div class="profile-email" id="profileEmail">user@example.com</div>
                    </div>
                </div>
                <ul class="profile-menu">
                    <li class="profile-menu-item" onclick="showPage('changePwdPage')">
                        <span class="text">Change Password</span>
                        <span class="arrow">â€º</span>
                    </li>
                    <li class="profile-menu-item" onclick="showNotificationSettings()">
                        <span class="text">Notification Settings</span>
                        <span class="arrow">â€º</span>
                    </li>
                    <li class="profile-menu-item" onclick="showPrivacySettings()">
                        <span class="text">Privacy Settings</span>
                        <span class="arrow">â€º</span>
                    </li>
                    <li class="profile-menu-item" onclick="showHelp()">
                        <span class="text">Help Center</span>
                        <span class="arrow">â€º</span>
                    </li>
                    <li class="profile-menu-item" onclick="logout()" style="color: #ff4444;">
                        <span class="text">Logout</span>
                        <span class="arrow">â€º</span>
                    </li>
                </ul>
            </div>
            <div style="height: 70px;"></div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:999;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:28px 18px 18px 18px;border-radius:16px;max-width:90vw;min-width:260px;text-align:center;position:relative;">
                <div style="font-size:1.2rem;font-weight:bold;margin-bottom:12px;">è«‹æƒæQR Codeå®Œæˆä»˜æ¬¾</div>
                <img id="qrImg" src="" alt="QR Code" style="width:180px;height:180px;margin-bottom:16px;"/>
                <div id="qrInfo" style="font-size:1.05rem;color:#333;margin-bottom:12px;"></div>
                <button onclick="closeQR()" style="padding:10px 28px;border-radius:8px;background:#1976d2;color:#fff;border:none;font-size:1.1rem;">é—œé–‰</button>
            </div>
        </div>
    </div>
    <script>
    // ====== API KEY ======
    const EXCHANGE_API_KEY = '8010374f266c76e1375a1810';
    const BASE_CURRENCY = 'TWD';
    const COUNTRY_MAP = {
        'THB': { name: 'Thailand', pair: 'TWD/THB', flag: 'th', local: 'à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢', symbol: 'à¸¿' },
        'VND': { name: 'Vietnam', pair: 'TWD/VND', flag: 'vn', local: 'Viá»‡t Nam', symbol: 'â‚«' },
        'PHP': { name: 'Philippines', pair: 'TWD/PHP', flag: 'ph', local: 'Pilipinas', symbol: 'â‚±' },
        'IDR': { name: 'Indonesia', pair: 'TWD/IDR', flag: 'id', local: 'Indonesia', symbol: 'Rp' }
    };
    let selectedCurrency = 'THB';
    let rateHistory = { 'THB': [], 'VND': [], 'PHP': [], 'IDR': [] };
    let lastRate = { 'THB': null, 'VND': null, 'PHP': null, 'IDR': null };
    let chart;
    let loggedIn = false;

    // ====== å¤šå¸³è™Ÿç®¡ç†ï¼ˆlocalStorageï¼‰ ======
    function getUsers() {
        return JSON.parse(localStorage.getItem('users')||'{}');
    }
    function setUsers(users) {
        localStorage.setItem('users', JSON.stringify(users));
    }
    let currentUser = null;
    function login() {
        const email = document.getElementById('loginEmail').value.trim();
        const pwd = document.getElementById('loginPwd').value.trim();
        const users = getUsers();
        if (!email || !pwd) { alert('è«‹è¼¸å…¥ä¿¡ç®±èˆ‡å¯†ç¢¼'); return; }
        if (!users[email] || users[email] !== pwd) { alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'); return; }
        currentUser = email;
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainPage').classList.remove('hidden');
        document.getElementById('navBar').style.display = '';
        showPage('mainPage');
    }
    function register() {
        const email = document.getElementById('regEmail').value.trim();
        const pwd = document.getElementById('regPwd').value.trim();
        const pwd2 = document.getElementById('regPwd2').value.trim();
        const users = getUsers();
        if (!email || !pwd || !pwd2) { alert('è«‹å®Œæ•´å¡«å¯«'); return; }
        if (pwd !== pwd2) { alert('å¯†ç¢¼ä¸ä¸€è‡´'); return; }
        if (users[email]) { alert('æ­¤ä¿¡ç®±å·²è¨»å†Š'); return; }
        users[email] = pwd;
        setUsers(users);
        alert('è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥');
        showPage('loginPage');
    }
    function resetPassword() {
        const email = document.getElementById('forgotEmail').value.trim();
        const pwd = document.getElementById('forgotPwd').value.trim();
        const pwd2 = document.getElementById('forgotPwd2').value.trim();
        const users = getUsers();
        if (!email || !pwd || !pwd2) { alert('è«‹å®Œæ•´å¡«å¯«'); return; }
        if (pwd !== pwd2) { alert('å¯†ç¢¼ä¸ä¸€è‡´'); return; }
        if (!users[email]) { alert('æŸ¥ç„¡æ­¤å¸³è™Ÿ'); return; }
        users[email] = pwd;
        setUsers(users);
        alert('å¯†ç¢¼å·²é‡è¨­ï¼Œè«‹ç™»å…¥');
        showPage('loginPage');
    }
    function changePassword() {
        const oldPwd = document.getElementById('oldPwd').value.trim();
        const newPwd = document.getElementById('newPwd').value.trim();
        const newPwd2 = document.getElementById('newPwd2').value.trim();
        const users = getUsers();
        if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
        if (!oldPwd || !newPwd || !newPwd2) { alert('è«‹å®Œæ•´å¡«å¯«'); return; }
        if (users[currentUser] !== oldPwd) { alert('èˆŠå¯†ç¢¼éŒ¯èª¤'); return; }
        if (newPwd !== newPwd2) { alert('æ–°å¯†ç¢¼ä¸ä¸€è‡´'); return; }
        users[currentUser] = newPwd;
        setUsers(users);
        alert('å¯†ç¢¼å·²ä¿®æ”¹');
        showPage('mainPage');
    }

    // ====== é é¢åˆ‡æ› ======
    function showPage(page) {
        ['mainPage','chatPage','exchangePage','loginPage','registerPage','forgotPage','changePwdPage','profilePage'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        const showEl = document.getElementById(page);
        if (showEl) showEl.classList.remove('hidden');
        // å°è¦½åˆ—iconé«˜äº®
        if(document.getElementById('navHome')) document.getElementById('navHome').classList.remove('active');
        if(document.getElementById('navBot')) document.getElementById('navBot').classList.remove('active');
        if(document.getElementById('navExchange')) document.getElementById('navExchange').classList.remove('active');
        if(document.getElementById('navProfile')) document.getElementById('navProfile').classList.remove('active');
        if(page==='mainPage' && document.getElementById('navHome')) document.getElementById('navHome').classList.add('active');
        if(page==='chatPage' && document.getElementById('navBot')) document.getElementById('navBot').classList.add('active');
        if(page==='exchangePage' && document.getElementById('navExchange')) document.getElementById('navExchange').classList.add('active');
        if(page==='profilePage' && document.getElementById('navProfile')) document.getElementById('navProfile').classList.add('active');
        
        // æ›´æ–°å€‹äººè³‡æ–™
        if (page === 'profilePage') {
            updateProfileInfo();
        }
    }

    // ====== åŒ¯ç‡èˆ‡åœ–è¡¨ ======
    function updateCard(rate, change) {
        document.getElementById('pair-label').textContent = COUNTRY_MAP[selectedCurrency].pair;
        document.getElementById('rate-value').textContent = rate.toFixed(4);
        document.getElementById('change-value').textContent = `${change > 0 ? '+' : ''}${change.toFixed(2)}% day over day`;
        document.getElementById('chart-label').textContent = COUNTRY_MAP[selectedCurrency].pair;
        // æ›åŒ¯é åŒæ­¥
        document.getElementById('ex-rate').textContent = rate.toFixed(4);
        const twd = parseFloat(document.getElementById('ex-twd').textContent)||3000;
        document.getElementById('ex-thb').textContent = `${COUNTRY_MAP[selectedCurrency].symbol} ${(twd*rate).toFixed(2)}`;
    }
    function updateChart() {
        const history = rateHistory[selectedCurrency];
        const labels = history.map(item => item.time);
        const data = history.map(item => item.rate);
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.options.scales.y.min = Math.min(...data) * 0.995;
        chart.options.scales.y.max = Math.max(...data) * 1.005;
        chart.update();
    }
    async function fetchRate() {
        try {
            const response = await fetch(`https://v6.exchangerate-api.com/v6/${EXCHANGE_API_KEY}/latest/${BASE_CURRENCY}`);
            const data = await response.json();
            if (data.result === 'success') {
                Object.keys(COUNTRY_MAP).forEach(cur => {
                    const rate = data.conversion_rates[cur];
                    const now = new Date();
                    const timeLabel = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0') + ':' + now.getSeconds().toString().padStart(2,'0');
                    // è¨ˆç®—æ¼²è·Œå¹…
                    let change = 0;
                    if (lastRate[cur] !== null) {
                        change = ((rate - lastRate[cur]) / lastRate[cur]) * 100;
                    }
                    lastRate[cur] = rate;
                    // æ›´æ–°æ­·å²è³‡æ–™
                    rateHistory[cur].push({ time: timeLabel, rate });
                    if (rateHistory[cur].length > 10) rateHistory[cur].shift();
                    // è‹¥æ˜¯ç›®å‰é¸æ“‡çš„åœ‹å®¶ï¼Œæ›´æ–°å¡ç‰‡èˆ‡åœ–è¡¨
                    if (cur === selectedCurrency) {
                        updateCard(rate, change);
                        updateChart();
                    }
                });
            }
        } catch (e) {
            console.error('åŒ¯ç‡ç²å–å¤±æ•—', e);
        }
    }
    document.getElementById('countrySelect').addEventListener('change', function(e) {
        selectedCurrency = e.target.value;
        if (rateHistory[selectedCurrency].length > 0) {
            const last = rateHistory[selectedCurrency][rateHistory[selectedCurrency].length-1];
            let change = 0;
            if (rateHistory[selectedCurrency].length > 1) {
                const prev = rateHistory[selectedCurrency][rateHistory[selectedCurrency].length-2];
                change = ((last.rate - prev.rate) / prev.rate) * 100;
            }
            updateCard(last.rate, change);
            updateChart();
        }
    });
    window.onload = function() {
        const ctx = document.getElementById('chart-currency').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: '', data: [], borderColor: '#1976d2', backgroundColor: 'rgba(25, 118, 210, 0.08)', fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#1976d2', }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#eee' }, beginAtZero: false } } }
        });
        fetchRate();
        setInterval(fetchRate, 10000);
        showMainOptions();
    }

    // ====== æ™ºèƒ½å®¢æœï¼ˆé¸é …å¼ï¼‰ ======
    const chatArea = document.getElementById('chatArea');
    const FAQ_OPTIONS = {
        'exchange': {
            title: 'æ›åŒ¯ç›¸é—œå•é¡Œ',
            options: [
                { text: 'å¦‚ä½•é€²è¡Œæ›åŒ¯ï¼Ÿ', response: 'æ‚¨å¯ä»¥åœ¨ä¸»é é¸æ“‡åœ‹å®¶ï¼Œç„¶å¾Œé»æ“Šæ›åŒ¯æŒ‰éˆ•é€²è¡Œæ›åŒ¯æ“ä½œã€‚' },
                { text: 'æ›åŒ¯æ‰‹çºŒè²»æ˜¯å¤šå°‘ï¼Ÿ', response: 'æˆ‘å€‘ç›®å‰æä¾›å…æ‰‹çºŒè²»çš„æ›åŒ¯æœå‹™ã€‚' },
                { text: 'æ›åŒ¯é¡åº¦é™åˆ¶ï¼Ÿ', response: 'å–®ç­†æ›åŒ¯ä¸Šé™ç‚º 50,000 å°å¹£ã€‚' }
            ]
        },
        'payment': {
            title: 'ä»˜æ¬¾ç›¸é—œå•é¡Œ',
            options: [
                { text: 'æ”¯æ´å“ªäº›ä»˜æ¬¾æ–¹å¼ï¼Ÿ', response: 'ç›®å‰æ”¯æ´å…¨å®¶ã€7-11ã€èŠçˆ¾å¯Œã€OK ç­‰ä¾¿åˆ©å•†åº—ä»˜æ¬¾ã€‚' },
                { text: 'ä»˜æ¬¾æœŸé™æ˜¯å¤šä¹…ï¼Ÿ', response: 'ä»˜æ¬¾æœŸé™ç‚º 24 å°æ™‚ï¼Œè«‹åœ¨æœŸé™å…§å®Œæˆä»˜æ¬¾ã€‚' },
                { text: 'å¦‚ä½•æŸ¥è©¢ä»˜æ¬¾ç‹€æ…‹ï¼Ÿ', response: 'æ‚¨å¯ä»¥åœ¨ä¸»é é»æ“Šè¨‚å–®æŸ¥è©¢ï¼Œè¼¸å…¥è¨‚å–®ç·¨è™Ÿå³å¯æŸ¥è©¢ã€‚' }
            ]
        },
        'account': {
            title: 'å¸³æˆ¶ç›¸é—œå•é¡Œ',
            options: [
                { text: 'å¦‚ä½•ä¿®æ”¹å¯†ç¢¼ï¼Ÿ', response: 'è«‹é»æ“Šå³ä¸Šè§’çš„è¨­å®šåœ–ç¤ºï¼Œé¸æ“‡ã€Œä¿®æ”¹å¯†ç¢¼ã€å³å¯é€²è¡Œä¿®æ”¹ã€‚' },
                { text: 'å¿˜è¨˜å¯†ç¢¼æ€éº¼è¾¦ï¼Ÿ', response: 'è«‹é»æ“Šç™»å…¥é é¢çš„ã€Œå¿˜è¨˜å¯†ç¢¼ã€ï¼Œä¾ç…§æŒ‡ç¤ºé‡è¨­å¯†ç¢¼ã€‚' },
                { text: 'å¦‚ä½•æ›´æ”¹å€‹äººè³‡æ–™ï¼Ÿ', response: 'è«‹é»æ“Šå³ä¸Šè§’çš„è¨­å®šåœ–ç¤ºï¼Œé¸æ“‡ã€Œå€‹äººè³‡æ–™ã€å³å¯é€²è¡Œä¿®æ”¹ã€‚' }
            ]
        }
    };

    function appendMsg(role, text) {
        const msg = document.createElement('div');
        msg.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
        msg.innerHTML = `<div class="bubble">${text.replace(/\n/g,'<br>')}</div>`;
        chatArea.appendChild(msg);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function appendOptions(category) {
        const msg = document.createElement('div');
        msg.className = 'msg bot';
        const faq = FAQ_OPTIONS[category];
        let html = `<div class="bubble">
            <div>${faq.title}</div>
            <div class="option-buttons">`;
        faq.options.forEach(option => {
            html += `<button class="option-btn" onclick="handleOptionClick('${option.text}')">${option.text}</button>`;
        });
        html += '</div></div>';
        msg.innerHTML = html;
        chatArea.appendChild(msg);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function handleOptionClick(question) {
        appendMsg('user', question);
        // å°‹æ‰¾å°æ‡‰çš„å›ç­”
        for (const category in FAQ_OPTIONS) {
            const option = FAQ_OPTIONS[category].options.find(opt => opt.text === question);
            if (option) {
                appendMsg('bot', option.response);
                break;
            }
        }
    }

    function showMainOptions() {
        appendMsg('bot', 'æ‚¨å¥½ï¼æˆ‘æ˜¯ Efficiency æ™ºèƒ½åŠ©ç†ï¼Œè«‹å•æœ‰ä»€éº¼å¯ä»¥å”åŠ©æ‚¨çš„å—ï¼Ÿ');
        const msg = document.createElement('div');
        msg.className = 'msg bot';
        let html = `<div class="bubble">
            <div class="option-buttons">`;
        for (const category in FAQ_OPTIONS) {
            html += `<button class="option-btn" onclick="appendOptions('${category}')">${FAQ_OPTIONS[category].title}</button>`;
        }
        html += '</div></div>';
        msg.innerHTML = html;
        chatArea.appendChild(msg);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function sendMsg() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;
        appendMsg('user', text);
        input.value = '';
        appendMsg('bot', 'æŠ±æ­‰ï¼Œæˆ‘ç›®å‰åªèƒ½å›ç­”é è¨­çš„å•é¡Œã€‚è«‹é»é¸ä¸Šæ–¹é¸é …ä¾†ç²å–å”åŠ©ã€‚');
        setTimeout(showMainOptions, 1000);
    }

    // ====== æ›åŒ¯é é‡‘é¡ã€åŒ¯ç‡ã€ä»˜æ¬¾æ–¹å¼ã€æŠ˜æ‰£ç¢¼ã€åœ‹å®¶äº’å‹• ======
    function updateExchangeAmount() {
        const cur = document.getElementById('ex-country').value;
        const twd = parseFloat(document.getElementById('ex-twd').value)||0;
        const rate = lastRate[cur]||1.0342;
        const symbol = COUNTRY_MAP[cur].symbol;
        document.getElementById('ex-rate').textContent = rate.toFixed(4);
        document.getElementById('ex-currency').textContent = cur;
        document.getElementById('ex-thb').textContent = `${symbol} ${(twd*rate).toFixed(2)}`;
    }
    document.getElementById('ex-twd').addEventListener('input', updateExchangeAmount);
    document.getElementById('ex-country').addEventListener('change', updateExchangeAmount);
    function confirmExchange() {
        const cur = document.getElementById('ex-country').value;
        const twd = document.getElementById('ex-twd').value;
        const rate = lastRate[cur]||1.0342;
        const symbol = COUNTRY_MAP[cur].symbol;
        const pay = document.getElementById('ex-pay').value;
        const promo = document.getElementById('ex-promo').value;
        const amount = (parseFloat(twd)*rate).toFixed(2);
        // QR Codeå…§å®¹
        const qrContent = `Country:${cur},Amount:${symbol}${amount},Payment:${pay},Promo:${promo||'None'}`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrContent)}`;
        document.getElementById('qrImg').src = qrUrl;
        document.getElementById('qrInfo').innerHTML = `Country: ${cur}<br>Amount: ${symbol} ${amount}<br>Payment: ${pay}<br>Promo: ${promo||'None'}`;
        document.getElementById('qrModal').style.display = 'flex';
    }
    function closeQR() {
        document.getElementById('qrModal').style.display = 'none';
    }
    function goExchange(cur) {
        document.getElementById('ex-country').value = cur;
        updateExchangeAmount();
        showPage('exchangePage');
    }

    // ====== Profile ç›¸é—œåŠŸèƒ½ ======
    function updateProfileInfo() {
        if (currentUser) {
            document.getElementById('profileName').textContent = currentUser.split('@')[0];
            document.getElementById('profileEmail').textContent = currentUser;
        }
    }

    function showNotificationSettings() {
        alert('Notification settings coming soon');
    }

    function showPrivacySettings() {
        alert('Privacy settings coming soon');
    }

    function showHelp() {
        showPage('chatPage');
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            currentUser = null;
            showPage('loginPage');
            document.getElementById('navBar').style.display = 'none';
        }
    }
    </script>
</body>
</html> 